@model CampusConnect.Models.Question
@using CampusConnect.Models
@{
    ViewData["Title"] = "Question Details";
    var assignedTags = ViewBag.AssignedTags as IEnumerable<Tag>;
    var availableTags = ViewBag.AvailableTags as IEnumerable<Tag>;
}

<div class="card shadow-sm mb-3">
    <div class="card-body">
        <h3 class="card-title">@Model.Title</h3>
        <p class="card-text">@Model.Content</p>
        <p class="text-muted">
            Asked by <strong>@Model.ApplicationUser.FullName</strong>
            on @Model.CreatedAt.ToString("g")
        </p>
    </div>
</div>

<hr />

<h5>Tags:</h5>
@if (assignedTags != null && assignedTags.Any())
{
    foreach (var tag in assignedTags)
    {
        <span class="badge bg-primary me-1">@tag.Name</span>
        @if (User.Identity.IsAuthenticated && Model.ApplicationUserId == User.FindFirst("sub")?.Value)
        {
            <form asp-controller="Tags" asp-action="Remove" method="post" class="d-inline">
                <input type="hidden" name="questionId" value="@Model.Id" />
                <input type="hidden" name="tagId" value="@tag.Id" />
                <button type="submit" class="btn btn-sm btn-outline-danger ms-1">x</button>
            </form>
        }
    }
}
else
{
    <p class="text-muted">No tags assigned.</p>
}

@if (User.Identity.IsAuthenticated && Model.ApplicationUserId == User.FindFirst("sub")?.Value)
{
    <div class="mt-3">
        <h6>Add a Tag:</h6>
        <form asp-controller="Tags" asp-action="Assign" method="post" class="d-flex">
            <input type="hidden" name="questionId" value="@Model.Id" />
            <select name="tagId" class="form-select me-2" style="max-width:200px;">
                @foreach (var tag in availableTags ?? Enumerable.Empty<Tag>())
                {
                    <option value="@tag.Id">@tag.Name</option>
                }
            </select>
            <button type="submit" class="btn btn-sm btn-success">Assign</button>
        </form>
    </div>
}

<hr />

@if (User.Identity.IsAuthenticated && Model.ApplicationUserId == User.FindFirst("sub")?.Value)
{
    <div class="mt-3">
        <a asp-action="Edit" asp-route-id="@Model.Id" class="btn btn-warning me-2">Edit</a>
        <a asp-action="Delete" asp-route-id="@Model.Id" class="btn btn-danger">Delete</a>
    </div>
}
<a asp-action="Index" class="btn btn-secondary mt-3">Back to List</a>
